// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum PlanType {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum WhatsAppAccountStatus {
  PENDING
  CONNECTED
  DISCONNECTED
  BANNED
}

enum ContactStatus {
  ACTIVE
  BLOCKED
  UNSUBSCRIBED
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  STICKER
  LOCATION
  CONTACT
  TEMPLATE
  INTERACTIVE
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum TemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TemplateCategory {
  MARKETING
  UTILITY
  AUTHENTICATION
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

enum ChatbotStatus {
  DRAFT
  ACTIVE
  PAUSED
}

enum AutomationTrigger {
  NEW_CONTACT
  KEYWORD
  WEBHOOK
  SCHEDULE
  INACTIVITY
}

enum NotificationType {
  MESSAGE
  CAMPAIGN
  TEAM
  BILLING
  SYSTEM
  ALERT
}

// ✅ NEW ENUMS
enum ConnectionStatus {
  PENDING
  CONNECTED
  DISCONNECTED
  ERROR
  TOKEN_EXPIRED
}

enum WebhookStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
}

// ============================================
// USER & ORGANIZATION
// ============================================

model User {
  id                   String     @id @default(cuid())
  email                String     @unique
  password             String?
  firstName            String
  lastName             String?
  phone                String?
  avatar               String?
  status               UserStatus @default(PENDING_VERIFICATION)
  
  emailVerified        Boolean    @default(false)
  emailVerifyToken     String?
  emailVerifyExpires   DateTime?
  
  passwordResetToken   String?
  passwordResetExpires DateTime?
  
  googleId             String?    @unique
  
  otpSecret            String?
  otpEnabled           Boolean    @default(false)
  
  lastLoginAt          DateTime?
  lastLoginIp          String?
  
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  
  ownedOrganizations   Organization[]       @relation("OrganizationOwner")
  memberships          OrganizationMember[]
  refreshTokens        RefreshToken[]
  activityLogs         ActivityLog[]
  notifications        Notification[]
  
  @@index([email])
  @@index([googleId])
}

model RefreshToken {
  id          String   @id @default(cuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  userAgent   String?
  ipAddress   String?
  
  @@index([userId])
  @@index([token])
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  website     String?
  industry    String?
  timezone    String   @default("UTC")
  
  ownerId     String
  owner       User     @relation("OrganizationOwner", fields: [ownerId], references: [id])
  
  planType    PlanType @default(FREE)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  members           OrganizationMember[]
  subscription      Subscription?
  whatsappAccounts  WhatsAppAccount[]
  contacts          Contact[]
  contactGroups     ContactGroup[]
  templates         Template[]
  campaigns         Campaign[]
  conversations     Conversation[]
  chatbots          Chatbot[]
  automations       Automation[]
  apiKeys           ApiKey[]
  webhooks          Webhook[]
  activityLogs      ActivityLog[]
  notifications     Notification[]
  
  // ✅ NEW RELATIONS
  metaConnection    MetaConnection?
  webhookLogs       WebhookLog[]
  
  @@index([slug])
  @@index([ownerId])
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           UserRole     @default(MEMBER)
  invitedAt      DateTime     @default(now())
  joinedAt       DateTime?
  
  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

// ============================================
// BILLING & SUBSCRIPTION
// ============================================

model Plan {
  id              String   @id @default(cuid())
  name            String
  type            PlanType @unique
  description     String?
  
  monthlyPrice    Decimal  @db.Decimal(10, 2)
  yearlyPrice     Decimal  @db.Decimal(10, 2)
  
  maxContacts     Int
  maxMessages     Int
  maxTeamMembers  Int
  maxCampaigns    Int
  maxChatbots     Int
  maxTemplates    Int
  
  features        Json     @default("[]")
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  subscriptions   Subscription[]
}

model Subscription {
  id                 String             @id @default(cuid())
  organizationId     String             @unique
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planId             String
  plan               Plan               @relation(fields: [planId], references: [id])
  
  status             SubscriptionStatus @default(ACTIVE)
  
  billingCycle       String             @default("monthly")
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  
  messagesUsed       Int                @default(0)
  contactsUsed       Int                @default(0)
  
  paymentMethod      String?
  lastPaymentAt      DateTime?
  nextPaymentAt      DateTime?
  
  cancelledAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  
  @@index([organizationId])
}

// ============================================
// WHATSAPP INTEGRATION
// ============================================

model WhatsAppAccount {
  id               String                @id @default(cuid())
  organizationId   String
  organization     Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  phoneNumberId    String                @unique
  wabaId           String
  phoneNumber      String
  displayName      String
  qualityRating    String?
  
  accessToken      String?               @db.Text
  tokenExpiresAt   DateTime?
  
  status           WhatsAppAccountStatus @default(PENDING)
  
  webhookSecret    String?
  
  isDefault        Boolean               @default(false)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  
  messages         Message[]
  campaigns        Campaign[]
  
  @@index([organizationId])
  @@index([phoneNumberId])
}

// ============================================
// ✅ META CONNECTION (NEW)
// ============================================

model MetaConnection {
  id                    String           @id @default(cuid())
  
  organizationId        String           @unique
  organization          Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  accessToken           String           @db.Text
  accessTokenExpiresAt  DateTime?
  
  wabaId                String
  wabaName              String?
  businessId            String?
  
  phoneNumbers          PhoneNumber[]
  
  status                ConnectionStatus @default(PENDING)
  lastSyncedAt          DateTime?
  errorMessage          String?
  
  webhookVerified       Boolean          @default(false)
  
  messagingLimit        String?
  qualityRating         String?
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([organizationId])
}

model PhoneNumber {
  id                    String         @id @default(cuid())
  
  metaConnectionId      String
  metaConnection        MetaConnection @relation(fields: [metaConnectionId], references: [id], onDelete: Cascade)
  
  phoneNumberId         String         @unique
  phoneNumber           String
  displayName           String?
  qualityRating         String?
  verifiedName          String?
  
  isActive              Boolean        @default(true)
  isPrimary             Boolean        @default(false)
  
  messagesLimit         Int?
  messagesUsed          Int            @default(0)
  lastResetAt           DateTime       @default(now())
  
  conversations         Conversation[]
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  @@index([phoneNumberId])
  @@index([metaConnectionId])
}

// ============================================
// ✅ WEBHOOK LOG (NEW)
// ============================================

model WebhookLog {
  id                String        @id @default(cuid())
  
  organizationId    String?
  organization      Organization? @relation(fields: [organizationId], references: [id])
  
  source            String
  eventType         String
  payload           Json
  
  status            WebhookStatus @default(PENDING)
  processedAt       DateTime?
  responseTime      Int?
  errorMessage      String?
  
  createdAt         DateTime      @default(now())
  
  @@index([organizationId])
  @@index([eventType])
  @@index([createdAt])
}

// ============================================
// CONTACTS
// ============================================

model Contact {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  phone          String
  countryCode    String        @default("+91")
  firstName      String?
  lastName       String?
  email          String?
  avatar         String?
  
  customFields   Json          @default("{}")
  
  tags           String[]      @default([])
  
  status         ContactStatus @default(ACTIVE)
  
  lastMessageAt  DateTime?
  messageCount   Int           @default(0)
  
  source         String?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  // Relations
  groups           ContactGroupMember[]
  conversations    Conversation[]
  campaignContacts CampaignContact[]
  
  @@unique([organizationId, phone])
  @@index([organizationId])
  @@index([phone])
  @@index([tags])
}

model ContactGroup {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name           String
  description    String?
  color          String?      @default("#25D366")
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  members        ContactGroupMember[]
  campaigns      Campaign[]
  
  @@unique([organizationId, name])
  @@index([organizationId])
}

model ContactGroupMember {
  id        String       @id @default(cuid())
  groupId   String
  group     ContactGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  contactId String
  contact   Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  addedAt   DateTime     @default(now())
  
  @@unique([groupId, contactId])
  @@index([groupId])
  @@index([contactId])
}

// ============================================
// MESSAGING
// ============================================

model Conversation {
  id                 String        @id @default(cuid())
  organizationId     String
  organization       Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contactId          String
  contact            Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  // ✅ NEW: Phone Number relation
  phoneNumberId      String?
  phoneNumber        PhoneNumber?  @relation(fields: [phoneNumberId], references: [id])
  
  lastMessageAt      DateTime?
  lastMessagePreview String?
  
  isArchived         Boolean       @default(false)
  isRead             Boolean       @default(true)
  unreadCount        Int           @default(0)
  
  assignedTo         String?
  
  labels             String[]      @default([])
  
  // ✅ NEW: Window tracking
  lastCustomerMessageAt DateTime?
  windowExpiresAt       DateTime?
  isWindowOpen          Boolean   @default(true)
  
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  
  messages           Message[]
  
  @@unique([organizationId, contactId])
  @@index([organizationId])
  @@index([contactId])
  @@index([lastMessageAt])
  @@index([phoneNumberId])
}

model Message {
  id                String           @id @default(cuid())
  conversationId    String
  conversation      Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  whatsappAccountId String?
  whatsappAccount   WhatsAppAccount? @relation(fields: [whatsappAccountId], references: [id])
  
  waMessageId       String?          @unique
  
  // ✅ NEW: Additional WhatsApp Message ID field
  wamId             String?          @unique
  
  direction         MessageDirection
  type              MessageType      @default(TEXT)
  
  content           String?
  mediaUrl          String?
  mediaType         String?
  mediaMimeType     String?
  
  templateId        String?
  templateName      String?
  templateParams    Json?
  
  status            MessageStatus    @default(PENDING)
  sentAt            DateTime?
  deliveredAt       DateTime?
  readAt            DateTime?
  failedAt          DateTime?
  failureReason     String?
  
  // ✅ NEW: Status tracking & retry
  statusUpdatedAt   DateTime?
  retryCount        Int              @default(0)
  
  replyToMessageId  String?
  
  metadata          Json?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([conversationId])
  @@index([waMessageId])
  @@index([wamId])
  @@index([createdAt])
}

// ============================================
// TEMPLATES
// ============================================

model Template {
  id              String           @id @default(cuid())
  organizationId  String
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  metaTemplateId  String?
  name            String
  language        String           @default("en")
  category        TemplateCategory @default(MARKETING)
  
  headerType      String?
  headerContent   String?
  bodyText        String
  footerText      String?
  
  buttons         Json             @default("[]")
  
  variables       Json             @default("[]")
  
  status          TemplateStatus   @default(PENDING)
  rejectionReason String?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  campaigns       Campaign[]
  
  @@unique([organizationId, name, language])
  @@index([organizationId])
  @@index([status])
}

// ============================================
// CAMPAIGNS
// ============================================

model Campaign {
  id                String          @id @default(cuid())
  organizationId    String
  organization      Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name              String
  description       String?
  
  templateId        String
  template          Template        @relation(fields: [templateId], references: [id])
  
  whatsappAccountId String
  whatsappAccount   WhatsAppAccount @relation(fields: [whatsappAccountId], references: [id])
  
  contactGroupId    String?
  contactGroup      ContactGroup?   @relation(fields: [contactGroupId], references: [id])
  
  audienceFilter    Json?
  
  status            CampaignStatus  @default(DRAFT)
  scheduledAt       DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  
  totalContacts     Int             @default(0)
  sentCount         Int             @default(0)
  deliveredCount    Int             @default(0)
  readCount         Int             @default(0)
  failedCount       Int             @default(0)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  contacts          CampaignContact[]
  
  @@index([organizationId])
  @@index([status])
  @@index([scheduledAt])
}

model CampaignContact {
  id            String        @id @default(cuid())
  campaignId    String
  campaign      Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId     String
  contact       Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  status        MessageStatus @default(PENDING)
  waMessageId   String?
  
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  failedAt      DateTime?
  failureReason String?
  
  retryCount    Int           @default(0)
  nextRetryAt   DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@index([status])
}

// ============================================
// CHATBOT
// ============================================

model Chatbot {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  
  flowData        Json          @default("{}")
  
  triggerKeywords String[]      @default([])
  
  isDefault       Boolean       @default(false)
  welcomeMessage  String?
  fallbackMessage String?
  
  status          ChatbotStatus @default(DRAFT)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([organizationId])
  @@index([status])
}

// ============================================
// AUTOMATION
// ============================================

model Automation {
  id             String            @id @default(cuid())
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name           String
  description    String?
  
  trigger        AutomationTrigger
  triggerConfig  Json              @default("{}")
  
  actions        Json              @default("[]")
  
  isActive       Boolean           @default(false)
  
  executionCount Int               @default(0)
  lastExecutedAt DateTime?
  
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  
  @@index([organizationId])
  @@index([trigger])
}

// ============================================
// API & WEBHOOKS
// ============================================

model ApiKey {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name           String
  key            String       @unique
  secret         String
  
  permissions    String[]     @default([])
  
  rateLimit      Int          @default(100)
  
  lastUsedAt     DateTime?
  usageCount     Int          @default(0)
  
  isActive       Boolean      @default(true)
  expiresAt      DateTime?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@index([organizationId])
  @@index([key])
}

model Webhook {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  url             String
  secret          String?
  
  events          String[]     @default([])
  
  isActive        Boolean      @default(true)
  
  lastTriggeredAt DateTime?
  successCount    Int          @default(0)
  failureCount    Int          @default(0)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([organizationId])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id             String        @id @default(cuid())
  
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  type           String        @default("system")
  title          String
  description    String
  actionUrl      String?
  
  metadata       Json          @default("{}")
  
  read           Boolean       @default(false)
  readAt         DateTime?
  
  createdAt      DateTime      @default(now())
  
  @@index([userId])
  @@index([userId, read])
  @@index([organizationId])
  @@index([createdAt])
}

// ============================================
// ACTIVITY LOGS
// ============================================

model ActivityLog {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action         String
  entity         String?
  entityId       String?
  
  metadata       Json          @default("{}")
  
  ipAddress      String?
  userAgent      String?
  
  createdAt      DateTime      @default(now())
  
  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// ADMIN
// ============================================

model AdminUser {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  name        String
  role        String   @default("admin")
  
  isActive    Boolean  @default(true)
  lastLoginAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([email])
}