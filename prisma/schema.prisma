generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextIndex", "fullTextSearch"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String               @id @default(cuid())
  email                String               @unique
  password             String?
  firstName            String
  lastName             String?
  phone                String?
  avatar               String?
  status               UserStatus           @default(PENDING_VERIFICATION)
  emailVerified        Boolean              @default(false)
  emailVerifyToken     String?
  emailVerifyExpires   DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?
  googleId             String?              @unique
  otpSecret            String?
  otpEnabled           Boolean              @default(false)
  lastLoginAt          DateTime?
  lastLoginIp          String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  activityLogs         ActivityLog[]
  notifications        Notification[]
  ownedOrganizations   Organization[]       @relation("OrganizationOwner")
  memberships          OrganizationMember[]
  refreshTokens        RefreshToken[]

  @@index([email])
  @@index([googleId])
  @@index([status])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  userAgent String?
  ipAddress String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Organization {
  id               String               @id @default(cuid())
  name             String
  slug             String               @unique
  logo             String?
  website          String?
  industry         String?
  timezone         String               @default("UTC")
  ownerId          String
  planType         PlanType             @default(FREE)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  activityLogs     ActivityLog[]
  apiKeys          ApiKey[]
  automations      Automation[]
  campaigns        Campaign[]
  chatbots         Chatbot[]
  contacts         Contact[]
  contactGroups    ContactGroup[]
  conversations    Conversation[]
  MetaConnection   MetaConnection?
  notifications    Notification[]
  owner            User                 @relation("OrganizationOwner", fields: [ownerId], references: [id])
  members          OrganizationMember[]
  subscription     Subscription?
  templates        Template[]
  webhooks         Webhook[]
  webhookLogs      WebhookLog[]
  whatsappAccounts WhatsAppAccount[]

  @@index([slug])
  @@index([ownerId])
  @@index([planType])
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           UserRole     @default(MEMBER)
  invitedAt      DateTime     @default(now())
  joinedAt       DateTime?
  updatedAt      DateTime     @default(now()) @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([role])
}

model Plan {
  id                   String         @id @default(cuid())
  name                 String
  type                 PlanType       @unique
  description          String?
  monthlyPrice         Decimal        @db.Decimal(10, 2)
  yearlyPrice          Decimal        @db.Decimal(10, 2)
  maxContacts          Int
  maxMessages          Int
  maxTeamMembers       Int
  maxCampaigns         Int
  maxChatbots          Int
  maxTemplates         Int
  features             Json           @default("[]")
  isActive             Boolean        @default(true)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  slug                 String         @unique
  maxWhatsAppAccounts  Int
  maxMessagesPerMonth  Int
  maxCampaignsPerMonth Int
  maxAutomations       Int
  maxApiCalls          Int
  subscriptions        Subscription[]

  @@index([slug])
  @@index([isActive])
  @@index([type])
}

model Subscription {
  id                 String             @id @default(cuid())
  organizationId     String             @unique
  planId             String
  status             SubscriptionStatus @default(ACTIVE)
  billingCycle       String             @default("monthly")
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  messagesUsed       Int                @default(0)
  contactsUsed       Int                @default(0)
  paymentMethod      String?
  lastPaymentAt      DateTime?
  nextPaymentAt      DateTime?
  cancelledAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan               Plan               @relation(fields: [planId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model WhatsAppAccount {
  id             String                @id @default(cuid())
  organizationId String
  phoneNumberId  String                @unique
  wabaId         String
  phoneNumber    String
  displayName    String
  qualityRating  String?
  accessToken    String?
  tokenExpiresAt DateTime?
  status         WhatsAppAccountStatus @default(PENDING)
  webhookSecret  String?
  isDefault      Boolean               @default(false)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  campaigns      Campaign[]
  messages       Message[]
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([wabaId])
  @@index([phoneNumberId])
  @@index([status])
}

model Contact {
  id               String               @id @default(cuid())
  organizationId   String
  phone            String
  countryCode      String               @default("+91")
  firstName        String?
  lastName         String?
  email            String?
  avatar           String?
  customFields     Json                 @default("{}")
  tags             String[]             @default([])
  status           ContactStatus        @default(ACTIVE)
  lastMessageAt    DateTime?
  messageCount     Int                  @default(0)
  source           String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  CampaignContact  CampaignContact[]
  organization     Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  groupMemberships ContactGroupMember[]
  conversations    Conversation[]

  @@unique([organizationId, phone])
  @@index([organizationId])
  @@index([phone])
  @@index([status])
  @@index([tags])
  @@index([lastMessageAt])
  @@index([createdAt])
}

model ContactGroup {
  id             String               @id @default(cuid())
  organizationId String
  name           String
  description    String?
  color          String?              @default("#25D366")
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  Campaign       Campaign[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        ContactGroupMember[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model ContactGroupMember {
  id        String       @id @default(cuid())
  groupId   String
  contactId String
  addedAt   DateTime     @default(now())
  contact   Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  group     ContactGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, contactId])
  @@index([groupId])
  @@index([contactId])
}

model Conversation {
  id                    String       @id @default(cuid())
  organizationId        String
  contactId             String
  lastMessageAt         DateTime?
  lastMessagePreview    String?
  isArchived            Boolean      @default(false)
  isRead                Boolean      @default(true)
  unreadCount           Int          @default(0)
  assignedTo            String?
  labels                String[]     @default([])
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  phoneNumberId         String?
  lastCustomerMessageAt DateTime?
  windowExpiresAt       DateTime?
  isWindowOpen          Boolean      @default(true)
  contact               Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  PhoneNumber           PhoneNumber? @relation(fields: [phoneNumberId], references: [id])
  messages              Message[]

  @@unique([organizationId, contactId])
  @@index([organizationId])
  @@index([contactId])
  @@index([isWindowOpen])
  @@index([lastMessageAt])
  @@index([assignedTo])
  @@index([isArchived])
  @@index([phoneNumberId])
}

model Message {
  id                String           @id @default(cuid())
  conversationId    String
  whatsappAccountId String?
  waMessageId       String?          @unique
  direction         MessageDirection
  type              MessageType      @default(TEXT)
  content           String?
  mediaUrl          String?
  mediaType         String?
  mediaMimeType     String?
  templateId        String?
  templateName      String?
  templateParams    Json?
  status            MessageStatus    @default(PENDING)
  sentAt            DateTime?
  deliveredAt       DateTime?
  readAt            DateTime?
  failedAt          DateTime?
  failureReason     String?
  replyToMessageId  String?
  metadata          Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  retryCount        Int              @default(0)
  statusUpdatedAt   DateTime?
  wamId             String?          @unique
  conversation      Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  whatsappAccount   WhatsAppAccount? @relation(fields: [whatsappAccountId], references: [id])

  @@index([conversationId])
  @@index([wamId])
  @@index([direction])
  @@index([status])
  @@index([createdAt])
  @@index([waMessageId])
}

model Template {
  id              String           @id @default(cuid())
  organizationId  String
  metaTemplateId  String?
  name            String
  language        String           @default("en")
  category        TemplateCategory @default(MARKETING)
  headerType      String?
  headerContent   String?
  bodyText        String
  footerText      String?
  buttons         Json             @default("[]")
  variables       Json             @default("[]")
  status          TemplateStatus   @default(PENDING)
  rejectionReason String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  campaigns       Campaign[]
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name, language])
  @@index([organizationId])
  @@index([metaTemplateId])
  @@index([status])
  @@index([category])
}

model Campaign {
  id                String            @id @default(cuid())
  organizationId    String
  name              String
  description       String?
  templateId        String
  whatsappAccountId String
  contactGroupId    String?
  audienceFilter    Json?
  status            CampaignStatus    @default(DRAFT)
  scheduledAt       DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  totalContacts     Int               @default(0)
  sentCount         Int               @default(0)
  deliveredCount    Int               @default(0)
  readCount         Int               @default(0)
  failedCount       Int               @default(0)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  ContactGroup      ContactGroup?     @relation(fields: [contactGroupId], references: [id])
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template          Template          @relation(fields: [templateId], references: [id])
  whatsappAccount   WhatsAppAccount   @relation(fields: [whatsappAccountId], references: [id])
  CampaignContact   CampaignContact[]

  @@index([organizationId])
  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
}

model Chatbot {
  id              String        @id @default(cuid())
  organizationId  String
  name            String
  description     String?
  flowData        Json          @default("{}")
  triggerKeywords String[]      @default([])
  isDefault       Boolean       @default(false)
  welcomeMessage  String?
  fallbackMessage String?
  status          ChatbotStatus @default(DRAFT)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([isDefault])
}

model Automation {
  id             String            @id @default(cuid())
  organizationId String
  name           String
  description    String?
  trigger        AutomationTrigger
  triggerConfig  Json              @default("{}")
  actions        Json              @default("[]")
  isActive       Boolean           @default(false)
  executionCount Int               @default(0)
  lastExecutedAt DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([trigger])
  @@index([isActive])
}

model ApiKey {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  key            String       @unique
  secret         String
  permissions    String[]     @default([])
  rateLimit      Int          @default(100)
  lastUsedAt     DateTime?
  usageCount     Int          @default(0)
  isActive       Boolean      @default(true)
  expiresAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([key])
  @@index([isActive])
}

model Webhook {
  id              String       @id @default(cuid())
  organizationId  String
  url             String
  secret          String?
  events          String[]     @default([])
  isActive        Boolean      @default(true)
  lastTriggeredAt DateTime?
  successCount    Int          @default(0)
  failureCount    Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isActive])
}

model WebhookLog {
  id             String        @id @default(cuid())
  organizationId String?
  source         String
  eventType      String
  payload        Json
  status         WebhookStatus @default(PENDING)
  processedAt    DateTime?
  responseTime   Int?
  errorMessage   String?
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([eventType])
  @@index([status])
  @@index([createdAt])
  @@index([source, eventType])
}

model Notification {
  id             String        @id @default(cuid())
  userId         String
  organizationId String?
  type           String        @default("system")
  title          String
  description    String
  actionUrl      String?
  metadata       Json          @default("{}")
  read           Boolean       @default(false)
  readAt         DateTime?
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
  @@index([organizationId])
  @@index([type])
  @@index([createdAt])
}

model ActivityLog {
  id             String          @id @default(cuid())
  organizationId String?
  userId         String?
  entity         String?
  entityId       String?
  metadata       Json            @default("{}")
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime        @default(now())
  action         ActivityAction?
  organization   Organization?   @relation(fields: [organizationId], references: [id])
  user           User?           @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model AdminUser {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String
  name        String
  role        String    @default("admin")
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
  @@index([role])
  @@index([isActive])
}

model CampaignContact {
  id            String        @id
  campaignId    String
  contactId     String
  status        MessageStatus @default(PENDING)
  waMessageId   String?
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  failedAt      DateTime?
  failureReason String?
  retryCount    Int           @default(0)
  nextRetryAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  Campaign      Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  Contact       Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@index([nextRetryAt])
  @@index([status])
}

model MetaConnection {
  id                   String           @id
  organizationId       String           @unique
  accessToken          String
  accessTokenExpiresAt DateTime?
  wabaId               String
  wabaName             String?
  businessId           String?
  status               ConnectionStatus @default(PENDING)
  lastSyncedAt         DateTime?
  errorMessage         String?
  webhookVerified      Boolean          @default(false)
  messagingLimit       String?
  qualityRating        String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime
  Organization         Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  PhoneNumber          PhoneNumber[]

  @@index([organizationId])
  @@index([status])
  @@index([wabaId])
}

model PhoneNumber {
  id               String         @id
  metaConnectionId String
  phoneNumberId    String         @unique
  phoneNumber      String
  displayName      String?
  qualityRating    String?
  verifiedName     String?
  isActive         Boolean        @default(true)
  isPrimary        Boolean        @default(false)
  messagesLimit    Int?
  messagesUsed     Int            @default(0)
  lastResetAt      DateTime       @default(now())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  Conversation     Conversation[]
  MetaConnection   MetaConnection @relation(fields: [metaConnectionId], references: [id], onDelete: Cascade)

  @@index([isActive, isPrimary])
  @@index([metaConnectionId])
  @@index([phoneNumberId])
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum PlanType {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum WhatsAppAccountStatus {
  PENDING
  CONNECTED
  DISCONNECTED
  BANNED
}

enum ContactStatus {
  ACTIVE
  BLOCKED
  UNSUBSCRIBED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  STICKER
  LOCATION
  CONTACT
  TEMPLATE
  INTERACTIVE
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum TemplateCategory {
  MARKETING
  UTILITY
  AUTHENTICATION
}

enum TemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

enum ChatbotStatus {
  DRAFT
  ACTIVE
  PAUSED
}

enum AutomationTrigger {
  NEW_CONTACT
  KEYWORD
  WEBHOOK
  SCHEDULE
  INACTIVITY
}

enum WebhookStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
}

enum NotificationType {
  MESSAGE
  CAMPAIGN
  TEAM
  BILLING
  SYSTEM
  ALERT
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  SEND
  RECEIVE
}

enum ConnectionStatus {
  PENDING
  CONNECTED
  DISCONNECTED
  ERROR
  TOKEN_EXPIRED
}
